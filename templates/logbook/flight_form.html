{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}
{% if form.instance.pk %}Edit Flight{% else %}Log New Flight{% endif %} - Wingman
{% endblock %}
{% block canonical_url %}{% if form.instance.pk %}{% url 'flight-update' form.instance.pk %}{% else %}{% url 'flight-create' %}{% endif %}{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h1 class="mb-2">
          <i class="fas fa-plane aviation-icon"></i>
          {% if form.instance.pk %}Edit Flight{% else %}Log New Flight{% endif %}
        </h1>
        <p class="text-muted">
          {% if form.instance.pk %}
            Update your flight details below.
          {% else %}
            Record your flight information to track your aviation journey.
          {% endif %}
        </p>
      </div>
      <a href="{% url 'flight-list' %}" class="btn btn-outline-secondary" style="font-weight: bold;">
        <i class="fas fa-arrow-left"></i>&nbsp;Back to Flights
      </a>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-lg-8 mx-auto">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="fas fa-clipboard-list aviation-icon"></i>
          Flight Information
        </h5>
      </div>
      <div class="card-body">
        {% include 'logbook/flight_form_custom.html' %}
      </div>
    </div>
  </div>
</div>

<!-- Help Information -->
<div class="row mt-4">
  <div class="col-lg-8 mx-auto">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="fas fa-question-circle aviation-icon"></i>
          Flight Logging Tips
        </h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <ul class="list-unstyled">
              <li>
                <i class="fas fa-check text-success"></i> Total time is
                auto-calculated from departure/arrival times
              </li>
              <li>
                <i class="fas fa-check text-success"></i> All time components are validated against total flight time
              </li>
              <li>
                <i class="fas fa-check text-success"></i> Single/Multi engine time is automatically set when selecting an aircraft
              </li>
            </ul>
          </div>
          <div class="col-md-6">
            <ul class="list-unstyled">
              <li>
                <i class="fas fa-check text-success"></i> Use "Full" buttons to quickly fill time fields
              </li>
              <li>
                <i class="fas fa-check text-success"></i> Enter times in HH:MM format (e.g., 01:30)
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const departureTime = document.getElementById("id_departure_time");
    const arrivalTime = document.getElementById("id_arrival_time");
    const dateField = document.getElementById("id_date");
    const aircraftSelect = document.getElementById("id_aircraft");
    const manualAircraftField = document.getElementById("id_manual_aircraft_registration");
    // Aircraft selection handling
    function handleAircraftSelection() {
      const selectedAircraft = aircraftSelect.value;
      
      if (selectedAircraft && manualAircraftField) {
        // Aircraft selected - clear manual field
        manualAircraftField.value = '';
      }
      

    }

    // Manual aircraft registration handling
    function handleManualAircraftInput() {
      const manualValue = manualAircraftField ? manualAircraftField.value.trim() : '';
      
      if (manualValue && aircraftSelect) {
        // Clear aircraft selection when manual registration is entered
        aircraftSelect.value = '';
      }
    }

    // Add event listeners for aircraft fields
    if (aircraftSelect) {
      aircraftSelect.addEventListener('change', handleAircraftSelection);
      // Initialize on page load
      handleAircraftSelection();
    }

    if (manualAircraftField) {
      manualAircraftField.addEventListener('input', handleManualAircraftInput);
      // Initialize on page load
      handleManualAircraftInput();
    }

    function calculateTotalTime() {
      if (departureTime && arrivalTime && dateField && departureTime.value && arrivalTime.value && dateField.value) {
        const departure = new Date(dateField.value + "T" + departureTime.value);
        const arrival = new Date(dateField.value + "T" + arrivalTime.value);

        // Handle overnight flights
        if (arrival < departure) {
          arrival.setDate(arrival.getDate() + 1);
        }

        const diffMs = arrival - departure;
        const diffHours = diffMs / (1000 * 60 * 60);

        // Update total time field if it exists
        const totalTimeField = document.getElementById("id_total_time");
        if (totalTimeField) {
          totalTimeField.value = diffHours.toFixed(1);
        }
      }
    }

    // Add event listeners only if elements exist
    if (departureTime) {
      departureTime.addEventListener("change", calculateTotalTime);
    }
    if (arrivalTime) {
      arrivalTime.addEventListener("change", calculateTotalTime);
    }
    if (dateField) {
      dateField.addEventListener("change", calculateTotalTime);
    }

    // Set default date to today if not set
    if (dateField && !dateField.value) {
      const today = new Date().toISOString().split("T")[0];
      dateField.value = today;
    }

    // Auto-format time inputs to HH:MM and add validation
    const timeInputs = document.querySelectorAll('input[name*="time"]');
    
    timeInputs.forEach(input => {
      // Check if this is a time breakdown field
      if (input.name.includes('night_time') || input.name.includes('ifr_time') || 
          input.name.includes('pic_time') || input.name.includes('copilot_time') ||
          input.name.includes('double_command_time') || input.name.includes('instructor_time') ||
          input.name.includes('simulator_time') || input.name.includes('multi_pilot_time')) {
        
        // Only set default if the field is empty (preserve existing values from form submission)
        if (!input.value || input.value === '') {
          input.value = '00:00';
        }
        
        // Add validation feedback
        input.addEventListener('change', function() {
          const timeValue = this.value;
          if (timeValue) {
            const [hours, minutes] = timeValue.split(':').map(Number);
            const totalMinutes = hours * 60 + minutes;
            
            // Show time in hours format for user reference
            const hoursDecimal = (totalMinutes / 60).toFixed(1);
            this.title = `${hoursDecimal} hours`;
          }
        });
      }
    });
    

  });
</script>
{% endblock %}

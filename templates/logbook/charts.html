{% extends 'base.html' %}
{% load static %}
{% block title %}Flight Analytics - Wingman{% endblock %}
{% block content %}
<div class="row">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h1 class="mb-2">
          <i class="fas fa-chart-line aviation-icon"></i>
          Flight Analytics
        </h1>
        <p class="text-muted">Visualize your flying progress and patterns</p>
      </div>
      <a href="{% url 'dashboard' %}" class="btn btn-outline-primary">
        <i class="fas fa-arrow-left"></i> Back to Dashboard
      </a>
    </div>
  </div>
</div>

<!-- Monthly Progress Chart -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="fas fa-chart-area aviation-icon"></i>
          Monthly Flight Hours Progress
        </h5>
      </div>
      <div class="card-body">
        <canvas id="monthlyProgressChart" height="100"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
  <!-- Aircraft Usage -->
  <div class="col-lg-6 mb-4">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="fas fa-helicopter aviation-icon"></i>
          Aircraft Usage
        </h5>
      </div>
      <div class="card-body">
        <canvas id="aircraftChart" height="200"></canvas>
      </div>
    </div>
  </div>

  <!-- Flight Type Distribution -->
  <div class="col-lg-6 mb-4">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="fas fa-chart-pie aviation-icon"></i>
          Flight Type Distribution
        </h5>
      </div>
      <div class="card-body">
        <canvas id="flightTypeChart" height="200"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Conditions and Time Breakdown -->
<div class="row mb-4">
  <!-- Flight Conditions -->
  <div class="col-lg-6 mb-4">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="fas fa-cloud-sun aviation-icon"></i>
          Flight Conditions
        </h5>
      </div>
      <div class="card-body">
        <canvas id="conditionsChart" height="200"></canvas>
      </div>
    </div>
  </div>

  <!-- Time Breakdown -->
  <div class="col-lg-6 mb-4">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="fas fa-clock aviation-icon"></i>
          Time Breakdown
        </h5>
      </div>
      <div class="card-body">
        <canvas id="timeBreakdownChart" height="200"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Statistics Row -->
<div class="row mb-4">
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="stats-card">
      <h3>{{ total_flights }}</h3>
      <p><i class="fas fa-plane"></i> Total Flights</p>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="stats-card">
      <h3>{{ total_hours|floatformat:1 }}</h3>
      <p><i class="fas fa-clock"></i> Total Hours</p>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="stats-card">
      <h3>{{ avg_flight_time|floatformat:1 }}</h3>
      <p><i class="fas fa-clock"></i> Avg Flight Time</p>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="stats-card">
      <h3>{{ most_used_aircraft }}</h3>
      <p><i class="fas fa-plane"></i> Most Used Aircraft</p>
    </div>
  </div>
</div>

<!-- Export & Share -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="fas fa-share-alt aviation-icon"></i>
          Export &amp; Share
        </h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-3 mb-2">
            <a href="{% url 'export-pdf' %}" class="btn btn-danger w-100" style="background-color: #dc3545; border-color: #dc3545; color: white; height: 48px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px;">
              <i class="fas fa-file-pdf"></i>&nbsp;Export PDF
            </a>
          </div>
          <div class="col-md-3 mb-2">
            <button class="btn btn-primary w-100" onclick="exportChartsData()" style="background-color: #0d6efd; border-color: #0d6efd; color: white; height: 48px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px;">
              <i class="fas fa-file-csv"></i>&nbsp;Export Flight Log (FAA/EASA)
            </button>
          </div>
          <div class="col-md-3 mb-2">
            <a href="{% url 'print-charts' %}" class="btn btn-success w-100" style="background-color: #198754; border-color: #198754; color: white; height: 48px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px;">
              <i class="fas fa-print"></i>&nbsp;Print Report
            </a>
          </div>
          <div class="col-md-3 mb-2">
            <a href="{% url 'flight-list' %}" class="btn btn-info w-100" style="background-color: #17a2b8; border-color: #17a2b8; color: white; height: 48px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px;">
              <i class="fas fa-list"></i>&nbsp;View Flights
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Chart.js configuration
  Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
  Chart.defaults.color = '#6c757d';

  // Monthly Progress Chart
  const monthlyData = {{ monthly_data|safe }};
  const monthlyCtx = document.getElementById('monthlyProgressChart').getContext('2d');

  new Chart(monthlyCtx, {
      type: 'line',
      data: {
          labels: monthlyData.map(item => item.month),
          datasets: [
              {
                  label: 'Total Hours',
                  data: monthlyData.map(item => item.total_hours),
                  borderColor: '#3b82f6',
                  backgroundColor: 'rgba(59, 130, 246, 0.1)',
                  borderWidth: 3,
                  fill: true,
                  tension: 0.4,
                  yAxisID: 'y'
              },
              {
                  label: 'Night Hours',
                  data: monthlyData.map(item => item.night_hours),
                  borderColor: '#1f2937',
                  backgroundColor: 'rgba(31, 41, 55, 0.1)',
                  borderWidth: 2,
                  fill: false,
                  tension: 0.4,
                  yAxisID: 'y'
              },
              {
                  label: 'Cross-Country Hours',
                  data: monthlyData.map(item => item.cross_country_hours),
                  borderColor: '#f59e0b',
                  backgroundColor: 'rgba(245, 158, 11, 0.1)',
                  borderWidth: 2,
                  fill: false,
                  tension: 0.4,
                  yAxisID: 'y'
              }
          ]
      },
      options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
              mode: 'index',
              intersect: false,
          },
          plugins: {
              legend: {
                  position: 'top',
              },
              title: {
                  display: false
              }
          },
          scales: {
              y: {
                  type: 'linear',
                  display: true,
                  position: 'left',
                  title: {
                      display: true,
                      text: 'Flight Hours'
                  }
              }
          }
      }
  });

  // Aircraft Usage Chart
  const aircraftData = {{ aircraft_data|safe }};
  const aircraftCtx = document.getElementById('aircraftChart').getContext('2d');

  new Chart(aircraftCtx, {
      type: 'doughnut',
      data: {
          labels: aircraftData.map(item => item.aircraft__registration),
          datasets: [{
              data: aircraftData.map(item => item.total_hours),
              backgroundColor: [
                  '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
                  '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#6366f1'
              ],
              borderWidth: 2,
              borderColor: '#ffffff'
          }]
      },
      options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
              legend: {
                  position: 'bottom',
              }
          }
      }
  });

  // Flight Type Distribution Chart
  const flightTypeData = {{ flight_type_data|safe }};
  const flightTypeCtx = document.getElementById('flightTypeChart').getContext('2d');

  new Chart(flightTypeCtx, {
      type: 'pie',
      data: {
          labels: flightTypeData.map(item => item.flight_type || 'Unknown'),
          datasets: [{
              data: flightTypeData.map(item => item.count),
              backgroundColor: [
                  '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'
              ],
              borderWidth: 2,
              borderColor: '#ffffff'
          }]
      },
      options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
              legend: {
                  position: 'bottom',
              }
          }
      }
  });

  // Flight Conditions Chart
  const conditionsData = {{ conditions_data|safe }};
  const conditionsCtx = document.getElementById('conditionsChart').getContext('2d');

  new Chart(conditionsCtx, {
      type: 'bar',
      data: {
          labels: conditionsData.map(item => item.conditions || 'Unknown'),
          datasets: [{
              label: 'Number of Flights',
              data: conditionsData.map(item => item.count),
              backgroundColor: '#3b82f6',
              borderColor: '#1d4ed8',
              borderWidth: 1
          }]
      },
      options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
              legend: {
                  display: false
              }
          },
          scales: {
              y: {
                  beginAtZero: true,
                  title: {
                      display: true,
                      text: 'Number of Flights'
                  }
              }
          }
      }
  });

  // Time Breakdown Chart (assuming we have this data)
  const timeBreakdownCtx = document.getElementById('timeBreakdownChart').getContext('2d');

  // Time breakdown chart with real data
  new Chart(timeBreakdownCtx, {
      type: 'radar',
      data: {
          labels: ['Total Hours', 'Night Time', 'Instrument Time', 'Cross-Country', 'Dual Instruction', 'Solo Time'],
          datasets: [{
              label: 'Current Hours',
              data: [{{ time_breakdown_data.total_hours|floatformat:1 }}, {{ time_breakdown_data.night_hours|floatformat:1 }}, {{ time_breakdown_data.ifr_hours|floatformat:1 }}, {{ time_breakdown_data.cross_country_hours|floatformat:1 }}, {{ time_breakdown_data.dual_instruction_hours|floatformat:1 }}, {{ time_breakdown_data.solo_hours|floatformat:1 }}],
              backgroundColor: 'rgba(59, 130, 246, 0.2)',
              borderColor: '#3b82f6',
              borderWidth: 2,
              pointBackgroundColor: '#3b82f6',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 2
          }]
      },
      options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
              legend: {
                  display: false
              }
          },
          scales: {
              r: {
                  beginAtZero: true,
                  title: {
                      display: true,
                      text: 'Hours'
                  }
              }
          }
      }
  });



  // Export charts data to CSV function
  function exportChartsData() {
      const downloadBtn = event.target;
      const originalText = downloadBtn.innerHTML;
      downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating CSV...';
      downloadBtn.disabled = true;
      
      try {
          // Get monthly data
          const monthlyData = {{ monthly_data|safe }};
          
          // Get aircraft data
          const aircraftData = {{ aircraft_data|safe }};
          
          // Get flight type data
          const flightTypeData = {{ flight_type_data|safe }};
          
          // Get conditions data
          const conditionsData = {{ conditions_data|safe }};
          
          // Create CSV content with FAA/EASA compliant flight log format
          let csvContent = '';
          
          // Header
          csvContent += 'FLIGHT LOGBOOK EXPORT - FAA/EASA COMPLIANT FORMAT\n';
          csvContent += `Generated on: ${new Date().toLocaleDateString()}\n`;
          csvContent += `Pilot: {{ user.get_full_name|default:user.username }}\n`;
          csvContent += '\n';
          
          // FAA/EASA Compliant Flight Log Structure
          csvContent += 'Date,AircraftID,AircraftType,From,To,Route,TotalTime,PIC,SIC,DualReceived,InstructorGiven,Solo,CrossCountry,Day,Night,IFR,SimulatedInstrument,Simulator,DayLandings,NightLandings,Remarks\n';
          
          // Get flight data from Django context
          const flightData = {{ flights_data|safe }};
          
          // Process each flight entry
          flightData.forEach(flight => {
              // Calculate role-based time breakdowns
              let picTime = 0.0, sicTime = 0.0, dualTime = 0.0, instructorTime = 0.0, soloTime = 0.0;
              
              if (flight.pilot_role === 'PIC') {
                  picTime = flight.total_time;
              } else if (flight.pilot_role === 'SIC') {
                  sicTime = flight.total_time;
              } else if (flight.pilot_role === 'DUAL') {
                  dualTime = flight.total_time;
              } else if (flight.pilot_role === 'INSTR') {
                  instructorTime = flight.total_time;
              } else if (flight.pilot_role === 'SOLO') {
                  soloTime = flight.total_time;
              }
              
              // Calculate day/night split (convert minutes to hours)
              const nightTimeHours = flight.night_time / 60;
              const dayTime = flight.total_time - nightTimeHours;
              
              // Determine if IFR or simulated instrument
              let ifrTime = 0.0, simulatedInstrumentTime = 0.0;
              if (flight.conditions === 'IFR') {
                  ifrTime = flight.total_time;
              } else if (flight.conditions === 'SIM') {
                  simulatedInstrumentTime = flight.total_time;
              }
              
              // Create route string
              const route = `${flight.departure_aerodrome}-${flight.arrival_aerodrome}`;
              
              // Format aircraft type with manufacturer
              const aircraftType = flight.aircraft.manufacturer && flight.aircraft.type ? 
                  `${flight.aircraft.manufacturer} ${flight.aircraft.type}` : 
                  flight.aircraft.type || 'N/A';
              
              // Create remarks
              let remarks = '';
              if (flight.instructor_name) {
                  remarks += `Instructor: ${flight.instructor_name}. `;
              }
              if (flight.flight_type) {
                  remarks += `Type: ${flight.flight_type}. `;
              }
              if (flight.remarks) {
                  remarks += flight.remarks;
              }
              remarks = remarks.trim() || 'N/A';
              
              // Build CSV row
              csvContent += `${flight.date},${flight.aircraft ? flight.aircraft.registration : flight.aircraft_registration},${aircraftType},${flight.departure_aerodrome},${flight.arrival_aerodrome},${route},${flight.total_time.toFixed(1)},${picTime.toFixed(1)},${sicTime.toFixed(1)},${dualTime.toFixed(1)},${instructorTime.toFixed(1)},${soloTime.toFixed(1)},${(flight.cross_country_time / 60).toFixed(1)},${dayTime.toFixed(1)},${(flight.night_time / 60).toFixed(1)},${ifrTime.toFixed(1)},${simulatedInstrumentTime.toFixed(1)},0.0,${flight.landings_day},${flight.landings_night},${remarks}\n`;
          });
          
          // Footer
          csvContent += '\n';
          csvContent += 'End of Flight Log\n';
          csvContent += `Generated by Wingman Flight Logbook on ${new Date().toLocaleString()}\n`;
          csvContent += 'Note: This format is designed to be compatible with both FAA and EASA logbook requirements.\n';
          
          // Create and download CSV file
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          const timestamp = new Date().toISOString().slice(0, 10);
          link.href = URL.createObjectURL(blob);
          link.download = `flight_analytics_data_${timestamp}.csv`;
          link.click();
          
          // Clean up
          URL.revokeObjectURL(link.href);
          
      } catch (error) {
          console.error('Error exporting CSV:', error);
      }
      
      // Restore button state
      downloadBtn.innerHTML = originalText;
      downloadBtn.disabled = false;
  }


  



</script>
{% endblock %}
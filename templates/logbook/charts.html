{% extends 'base.html' %}
{% load static %}
{% block title %}Flight Analytics - Wingman{% endblock %}
{% block content %}
<div class="row">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h1 class="mb-2">
          <i class="fas fa-chart-line aviation-icon"></i>
          Flight Analytics
        </h1>
        <p class="text-muted">Visualize your flying progress and patterns</p>
      </div>
      <a href="{% url 'dashboard' %}" class="btn btn-outline-primary">
        <i class="fas fa-arrow-left"></i> Back to Dashboard
      </a>
    </div>
  </div>
</div>

<!-- Monthly Progress Chart -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="fas fa-chart-area aviation-icon"></i>
          Monthly Flight Hours Progress
        </h5>
      </div>
      <div class="card-body">
        <canvas id="monthlyProgressChart" height="100"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
  <!-- Aircraft Usage -->
  <div class="col-lg-6 mb-4">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="fas fa-helicopter aviation-icon"></i>
          Aircraft Usage
        </h5>
      </div>
      <div class="card-body">
        <canvas id="aircraftChart" height="200"></canvas>
      </div>
    </div>
  </div>

  <!-- Flight Type Distribution -->
  <div class="col-lg-6 mb-4">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="fas fa-chart-pie aviation-icon"></i>
          Flight Type Distribution
        </h5>
      </div>
      <div class="card-body">
        <canvas id="flightTypeChart" height="200"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Conditions and Time Breakdown -->
<div class="row mb-4">
  <!-- Flight Conditions -->
  <div class="col-lg-6 mb-4">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="fas fa-cloud-sun aviation-icon"></i>
          Flight Conditions
        </h5>
      </div>
      <div class="card-body">
        <canvas id="conditionsChart" height="200"></canvas>
      </div>
    </div>
  </div>

  <!-- Time Breakdown -->
  <div class="col-lg-6 mb-4">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="fas fa-clock aviation-icon"></i>
          Time Breakdown
        </h5>
      </div>
      <div class="card-body">
        <canvas id="timeBreakdownChart" height="200"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Statistics Row -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="fas fa-info-circle aviation-icon"></i>
          Flight Statistics
        </h5>
      </div>
      <div class="card-body">
        <div class="row text-center">
          <div class="col-md-3 mb-3">
            <div class="stat-item">
              <h3 class="text-primary" id="totalFlights">{{ total_flights }}</h3>
              <p class="text-muted mb-0">Total Flights</p>
            </div>
          </div>
          <div class="col-md-3 mb-3">
            <div class="stat-item">
              <h3 class="text-success" id="totalHours">{{ total_hours|floatformat:1 }}</h3>
              <p class="text-muted mb-0">Total Hours</p>
            </div>
          </div>
          <div class="col-md-3 mb-3">
            <div class="stat-item">
              <h3 class="text-info" id="avgFlightTime">{{ avg_flight_time|floatformat:1 }}</h3>
              <p class="text-muted mb-0">Avg Flight Time</p>
            </div>
          </div>
          <div class="col-md-3 mb-3">
            <div class="stat-item">
              <h3 class="text-warning" id="mostUsedAircraft">{{ most_used_aircraft }}</h3>
              <p class="text-muted mb-0">Most Used Aircraft</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Export & Share -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="fas fa-share-alt aviation-icon"></i>
          Export &amp; Share
        </h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-3 mb-2">
            <a href="{% url 'export-pdf' %}" class="btn btn-warning w-100">
              <i class="fas fa-file-pdf"></i> Export PDF
            </a>
          </div>
          <div class="col-md-3 mb-2">
            <button class="btn btn-info w-100" onclick="exportChartsData()">
              <i class="fas fa-file-csv"></i> Export Analytics Report
            </button>
          </div>
          <div class="col-md-3 mb-2">
            <button class="btn btn-success w-100" onclick="printCharts()">
              <i class="fas fa-print"></i> Print Report
            </button>
          </div>
          <div class="col-md-3 mb-2">
            <a href="{% url 'flight-list' %}" class="btn btn-primary w-100">
              <i class="fas fa-list"></i> View Flights
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Chart.js configuration
  Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
  Chart.defaults.color = '#6c757d';

  // Monthly Progress Chart
  const monthlyData = {{ monthly_data|safe }};
  const monthlyCtx = document.getElementById('monthlyProgressChart').getContext('2d');

  new Chart(monthlyCtx, {
      type: 'line',
      data: {
          labels: monthlyData.map(item => item.month),
          datasets: [
              {
                  label: 'Total Hours',
                  data: monthlyData.map(item => item.total_hours),
                  borderColor: '#3b82f6',
                  backgroundColor: 'rgba(59, 130, 246, 0.1)',
                  borderWidth: 3,
                  fill: true,
                  tension: 0.4,
                  yAxisID: 'y'
              },
              {
                  label: 'Night Hours',
                  data: monthlyData.map(item => item.night_hours),
                  borderColor: '#1f2937',
                  backgroundColor: 'rgba(31, 41, 55, 0.1)',
                  borderWidth: 2,
                  fill: false,
                  tension: 0.4,
                  yAxisID: 'y'
              },
              {
                  label: 'Cross-Country Hours',
                  data: monthlyData.map(item => item.cross_country_hours),
                  borderColor: '#f59e0b',
                  backgroundColor: 'rgba(245, 158, 11, 0.1)',
                  borderWidth: 2,
                  fill: false,
                  tension: 0.4,
                  yAxisID: 'y'
              }
          ]
      },
      options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
              mode: 'index',
              intersect: false,
          },
          plugins: {
              legend: {
                  position: 'top',
              },
              title: {
                  display: false
              }
          },
          scales: {
              y: {
                  type: 'linear',
                  display: true,
                  position: 'left',
                  title: {
                      display: true,
                      text: 'Flight Hours'
                  }
              }
          }
      }
  });

  // Aircraft Usage Chart
  const aircraftData = {{ aircraft_data|safe }};
  const aircraftCtx = document.getElementById('aircraftChart').getContext('2d');

  new Chart(aircraftCtx, {
      type: 'doughnut',
      data: {
          labels: aircraftData.map(item => item.aircraft__registration),
          datasets: [{
              data: aircraftData.map(item => item.total_hours),
              backgroundColor: [
                  '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
                  '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#6366f1'
              ],
              borderWidth: 2,
              borderColor: '#ffffff'
          }]
      },
      options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
              legend: {
                  position: 'bottom',
              }
          }
      }
  });

  // Flight Type Distribution Chart
  const flightTypeData = {{ flight_type_data|safe }};
  const flightTypeCtx = document.getElementById('flightTypeChart').getContext('2d');

  new Chart(flightTypeCtx, {
      type: 'pie',
      data: {
          labels: flightTypeData.map(item => item.flight_type || 'Unknown'),
          datasets: [{
              data: flightTypeData.map(item => item.count),
              backgroundColor: [
                  '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'
              ],
              borderWidth: 2,
              borderColor: '#ffffff'
          }]
      },
      options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
              legend: {
                  position: 'bottom',
              }
          }
      }
  });

  // Flight Conditions Chart
  const conditionsData = {{ conditions_data|safe }};
  const conditionsCtx = document.getElementById('conditionsChart').getContext('2d');

  new Chart(conditionsCtx, {
      type: 'bar',
      data: {
          labels: conditionsData.map(item => item.conditions || 'Unknown'),
          datasets: [{
              label: 'Number of Flights',
              data: conditionsData.map(item => item.count),
              backgroundColor: '#3b82f6',
              borderColor: '#1d4ed8',
              borderWidth: 1
          }]
      },
      options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
              legend: {
                  display: false
              }
          },
          scales: {
              y: {
                  beginAtZero: true,
                  title: {
                      display: true,
                      text: 'Number of Flights'
                  }
              }
          }
      }
  });

  // Time Breakdown Chart (assuming we have this data)
  const timeBreakdownCtx = document.getElementById('timeBreakdownChart').getContext('2d');

  // Time breakdown chart with real data
  new Chart(timeBreakdownCtx, {
      type: 'radar',
      data: {
          labels: ['Total Hours', 'Night Time', 'Instrument Time', 'Cross-Country', 'Dual Instruction', 'Solo Time'],
          datasets: [{
              label: 'Current Hours',
              data: [{{ total_hours|floatformat:1 }}, {{ pilot_profile.total_night_hours|floatformat:1 }}, {{ pilot_profile.total_instrument_hours|floatformat:1 }}, {{ pilot_profile.total_cross_country_hours|floatformat:1 }}, {{ pilot_profile.total_dual_hours|floatformat:1 }}, {{ pilot_profile.total_solo_hours|floatformat:1 }}],
              backgroundColor: 'rgba(59, 130, 246, 0.2)',
              borderColor: '#3b82f6',
              borderWidth: 2,
              pointBackgroundColor: '#3b82f6',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 2
          }]
      },
      options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
              legend: {
                  display: false
              }
          },
          scales: {
              r: {
                  beginAtZero: true,
                  title: {
                      display: true,
                      text: 'Hours'
                  }
              }
          }
      }
  });

  // Update statistics
  function updateStats() {
      // Use real data from Django context
      document.getElementById('totalFlights').textContent = '{{ total_flights }}';
      document.getElementById('totalHours').textContent = '{{ total_hours|floatformat:1 }}';
      document.getElementById('avgFlightTime').textContent = '{{ avg_flight_time|floatformat:1 }}';
      document.getElementById('mostUsedAircraft').textContent = '{{ most_used_aircraft }}';
  }

  // Export charts data to CSV function
  function exportChartsData() {
      const downloadBtn = event.target;
      const originalText = downloadBtn.innerHTML;
      downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating CSV...';
      downloadBtn.disabled = true;
      
      try {
          // Get monthly data
          const monthlyData = {{ monthly_data|safe }};
          
          // Get aircraft data
          const aircraftData = {{ aircraft_data|safe }};
          
          // Get flight type data
          const flightTypeData = {{ flight_type_data|safe }};
          
          // Get conditions data
          const conditionsData = {{ conditions_data|safe }};
          
          // Create CSV content with better organization
          let csvContent = 'FLIGHT ANALYTICS DATA EXPORT\n';
          csvContent += `Generated on: ${new Date().toLocaleDateString()}\n`;
          csvContent += `Pilot: {{ user.get_full_name|default:user.username }}\n`;
          csvContent += '='.repeat(50) + '\n\n';
          
          // Summary Statistics Section
          csvContent += 'SUMMARY STATISTICS\n';
          csvContent += '='.repeat(20) + '\n';
          csvContent += 'Metric,Value\n';
          csvContent += `Total Flights,{{ total_flights }}\n`;
          csvContent += `Total Flight Hours,{{ total_hours|floatformat:1 }}\n`;
          csvContent += `Average Flight Duration,{{ avg_flight_time|floatformat:1 }} hours\n`;
          csvContent += `Most Used Aircraft,{{ most_used_aircraft }}\n`;
          csvContent += '\n';
          
          // Monthly Progress Section
          csvContent += 'MONTHLY FLIGHT PROGRESS (Last 12 Months)\n';
          csvContent += '='.repeat(40) + '\n';
          csvContent += 'Month,Total Hours,Night Hours,Cross-Country Hours,Total Flights\n';
          monthlyData.forEach(item => {
              csvContent += `${item.month},${item.total_hours.toFixed(1)},${item.night_hours.toFixed(1)},${item.cross_country_hours.toFixed(1)},0\n`;
          });
          csvContent += '\n';
          
          // Aircraft Performance Section
          csvContent += 'AIRCRAFT PERFORMANCE & USAGE\n';
          csvContent += '='.repeat(35) + '\n';
          csvContent += 'Aircraft Registration,Total Hours,Flight Count,Average Hours per Flight\n';
          aircraftData.forEach(item => {
              const avgHours = item.total_hours > 0 ? (item.total_hours / item.flight_count).toFixed(1) : '0.0';
              csvContent += `${item.aircraft__registration},${item.total_hours.toFixed(1)},${item.flight_count},${avgHours}\n`;
          });
          csvContent += '\n';
          
          // Flight Type Analysis Section
          csvContent += 'FLIGHT TYPE DISTRIBUTION\n';
          csvContent += '='.repeat(30) + '\n';
          csvContent += 'Flight Type,Number of Flights,Percentage of Total\n';
          const totalFlightTypes = flightTypeData.reduce((sum, item) => sum + item.count, 0);
          flightTypeData.forEach(item => {
              const percentage = totalFlightTypes > 0 ? ((item.count / totalFlightTypes) * 100).toFixed(1) : '0.0';
              csvContent += `${item.flight_type || 'Unknown'},${item.count},${percentage}%\n`;
          });
          csvContent += '\n';
          
          // Weather Conditions Section
          csvContent += 'FLIGHT CONDITIONS ANALYSIS\n';
          csvContent += '='.repeat(30) + '\n';
          csvContent += 'Weather Conditions,Number of Flights,Percentage of Total\n';
          const totalConditions = conditionsData.reduce((sum, item) => sum + item.count, 0);
          conditionsData.forEach(item => {
              const percentage = totalConditions > 0 ? ((item.count / totalConditions) * 100).toFixed(1) : '0.0';
              csvContent += `${item.conditions || 'Unknown'},${item.count},${percentage}%\n`;
          });
          csvContent += '\n';
          
          // Time Breakdown Section
          csvContent += 'TIME BREAKDOWN SUMMARY\n';
          csvContent += '='.repeat(25) + '\n';
          csvContent += 'Time Category,Hours\n';
          csvContent += `Total Flight Time,{{ total_hours|floatformat:1 }}\n`;
          csvContent += `Night Time,{{ pilot_profile.total_night_hours|floatformat:1 }}\n`;
          csvContent += `Instrument Time,{{ pilot_profile.total_instrument_hours|floatformat:1 }}\n`;
          csvContent += `Cross-Country Time,{{ pilot_profile.total_cross_country_hours|floatformat:1 }}\n`;
          csvContent += `Dual Instruction,{{ pilot_profile.total_dual_hours|floatformat:1 }}\n`;
          csvContent += `Solo Time,{{ pilot_profile.total_solo_hours|floatformat:1 }}\n`;
          csvContent += '\n';
          
          // Footer
          csvContent += '='.repeat(50) + '\n';
          csvContent += 'End of Report\n';
          csvContent += `Generated by Wingman Flight Logbook on ${new Date().toLocaleString()}\n`;
          
          // Create and download CSV file
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          const timestamp = new Date().toISOString().slice(0, 10);
          link.href = URL.createObjectURL(blob);
          link.download = `flight_analytics_data_${timestamp}.csv`;
          link.click();
          
          // Clean up
          URL.revokeObjectURL(link.href);
          
          // Show success message
          showMessage('CSV data exported successfully!', 'success');
          
      } catch (error) {
          console.error('Error exporting CSV:', error);
          showMessage('Error exporting data. Please try again.', 'error');
      }
      
      // Restore button state
      downloadBtn.innerHTML = originalText;
      downloadBtn.disabled = false;
  }

  // Show message function
  function showMessage(message, type = 'info') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'info'} alert-dismissible fade show`;
      alertDiv.style.position = 'fixed';
      alertDiv.style.top = '20px';
      alertDiv.style.right = '20px';
      alertDiv.style.zIndex = '9999';
      alertDiv.style.minWidth = '300px';
      
      alertDiv.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      document.body.appendChild(alertDiv);
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
          if (alertDiv.parentNode) {
              alertDiv.parentNode.removeChild(alertDiv);
          }
      }, 5000);
  }
  
  // Print charts function
  function printCharts() {
      window.print();
  }

  // Initialize stats
  document.addEventListener('DOMContentLoaded', function() {
      updateStats();
  });
</script>
{% endblock %}
§
{% load crispy_forms_tags %}
{% load time_filters %}

<style>
    /* Error styling for time input fields to match crispy forms */
    .time-input-error .input-group {
        position: relative;
    }
    
    .time-input-error .input-group .form-control {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
    }
    
    .time-input-error .input-group .form-control:focus {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
    }
    
    /* Error icon styling */
    .time-input-error .input-group::after {
        content: "!";
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        background: #dc3545;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: bold;
        color: white;
        z-index: 10;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    /* Style error messages to match crispy forms */
    .invalid-feedback {
        display: block !important;
        color: #dc3545 !important;
        font-size: 0.875em;
        margin-top: 0.25rem;
    }
</style>

<form method="post" class="form">
    {% csrf_token %}
    

    
    <!-- Display non-field errors only -->
    {% if form.non_field_errors %}
        <div class="alert alert-danger">
            {% for error in form.non_field_errors %}
                <div class="mb-0">{{ error }}</div>
            {% endfor %}
        </div>
    {% endif %}
    
    <!-- Basic Flight Information -->
    <div class="row">
        <div class="col-md-6 mb-3">
            {{ form.date|as_crispy_field }}
        </div>
        <div class="col-md-6 mb-3">
            {{ form.aircraft|as_crispy_field }}
        </div>
    </div>
    

    
    <div class="row">
        <div class="col-md-6 mb-3">
            {{ form.departure_aerodrome|as_crispy_field }}
        </div>
        <div class="col-md-6 mb-3">
            {{ form.arrival_aerodrome|as_crispy_field }}
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6 mb-3">
            {{ form.departure_time|as_crispy_field }}
        </div>
        <div class="col-md-6 mb-3">
            {{ form.arrival_time|as_crispy_field }}
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6 mb-3">
            <!-- Empty column for balance -->
        </div>
        <div class="col-md-6 mb-3">
            <!-- Empty column for balance -->
        </div>
    </div>
    
    <!-- Engine Time -->
    <div class="row">
        <div class="col-md-6 mb-4">
            <label class="form-label">{{ form.night_time.label }}</label>
            <div class="{% if form.night_time.errors %}time-input-error{% endif %}">
                {% time_input_with_button form.night_time %}
            </div>
            {% if form.night_time.help_text %}
                <small class="form-text text-muted">{{ form.night_time.help_text }}</small>
            {% endif %}
            {% if form.night_time.errors %}
                <div class="invalid-feedback d-block">
                    {% for error in form.night_time.errors %}
                        <small class="text-danger">{{ error }}</small>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        <div class="col-md-6 mb-3">
            <label class="form-label">{{ form.ifr_time.label }}</label>
            <div class="{% if form.ifr_time.errors %}time-input-error{% endif %}">
                {% time_input_with_button form.ifr_time %}
            </div>
            {% if form.ifr_time.help_text %}
                <small class="form-text text-muted">{{ form.ifr_time.help_text }}</small>
            {% endif %}
            {% if form.ifr_time.errors %}
                <div class="invalid-feedback d-block">
                    {% for error in form.ifr_time.errors %}
                        <small class="text-danger">{{ error }}</small>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Landings and Approaches -->
    <div class="row">
        <div class="col-md-4 mb-3">
            {{ form.day_landings|as_crispy_field }}
        </div>
        <div class="col-md-4 mb-3">
            {{ form.night_landings|as_crispy_field }}
        </div>
        <div class="col-md-4 mb-3">
            {{ form.ifr_approaches|as_crispy_field }}
        </div>
    </div>
    
    <!-- Pilot Time -->
    <div class="row">
        <div class="col-md-4 mb-3">
            {{ form.pic_name|as_crispy_field }}
        </div>
        <div class="col-md-4 mb-3">
            <label class="form-label">{{ form.pic_time.label }}</label>
            <div class="{% if form.pic_time.errors %}time-input-error{% endif %}">
                {% time_input_with_button form.pic_time %}
            </div>
            {% if form.pic_time.help_text %}
                <small class="form-text text-muted">{{ form.pic_time.help_text }}</small>
            {% endif %}
            {% if form.pic_time.errors %}
                <div class="invalid-feedback d-block">
                    {% for error in form.pic_time.errors %}
                        <small class="text-danger">{{ error }}</small>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        <div class="col-md-4 mb-3">
            <label class="form-label">{{ form.multi_pilot_time.label }}</label>
            <div class="{% if form.multi_pilot_time.errors %}time-input-error{% endif %}">
                {% time_input_with_button form.multi_pilot_time %}
            </div>
            {% if form.multi_pilot_time.help_text %}
                <small class="form-text text-muted">{{ form.multi_pilot_time.help_text }}</small>
            {% endif %}
            {% if form.multi_pilot_time.errors %}
                <div class="invalid-feedback d-block">
                    {% for error in form.multi_pilot_time.errors %}
                        <small class="text-danger">{{ error }}</small>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-4 mb-3">
            <label class="form-label">{{ form.copilot_time.label }}</label>
            <div class="{% if form.copilot_time.errors %}time-input-error{% endif %}">
                {% time_input_with_button form.copilot_time %}
            </div>
            {% if form.copilot_time.help_text %}
                <small class="form-text text-muted">{{ form.copilot_time.help_text }}</small>
            {% endif %}
            {% if form.copilot_time.errors %}
                <div class="invalid-feedback d-block">
                    {% for error in form.copilot_time.errors %}
                        <small class="text-danger">{{ error }}</small>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        <div class="col-md-4 mb-3">
            <label class="form-label">{{ form.double_command_time.label }}</label>
            <div class="{% if form.double_command_time.errors %}time-input-error{% endif %}">
                {% time_input_with_button form.double_command_time %}
            </div>
            {% if form.double_command_time.help_text %}
                <small class="form-text text-muted">{{ form.double_command_time.help_text }}</small>
            {% endif %}
            {% if form.double_command_time.errors %}
                <div class="invalid-feedback d-block">
                    {% for error in form.double_command_time.errors %}
                        <small class="text-danger">{{ error }}</small>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        <div class="col-md-4 mb-3">
            <label class="form-label">{{ form.instructor_time.label }}</label>
            <div class="{% if form.instructor_time.errors %}time-input-error{% endif %}">
                {% time_input_with_button form.instructor_time %}
            </div>
            {% if form.instructor_time.help_text %}
                <small class="form-text text-muted">{{ form.instructor_time.help_text }}</small>
            {% endif %}
            {% if form.instructor_time.errors %}
                <div class="invalid-feedback d-block">
                    {% for error in form.instructor_time.errors %}
                        <small class="text-danger">{{ error }}</small>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Simulator -->
    <div class="row">
        <div class="col-md-6 mb-3">
            {{ form.simulator_type|as_crispy_field }}
        </div>
        <div class="col-md-6 mb-3">
            <label class="form-label">{{ form.simulator_time.label }}</label>
            <div class="{% if form.simulator_time.errors %}time-input-error{% endif %}">
                {% time_input_with_button form.simulator_time %}
            </div>
            {% if form.simulator_time.help_text %}
                <small class="form-text text-muted">{{ form.simulator_time.help_text }}</small>
            {% endif %}
            {% if form.simulator_time.errors %}
                <div class="invalid-feedback d-block">
                    {% for error in form.simulator_time.errors %}
                        <small class="text-danger">{{ error }}</small>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Remarks -->
    <div class="row">
        <div class="col-md-12 mb-3">
            {{ form.remarks|as_crispy_field }}
        </div>
    </div>
    
    <!-- Submit Buttons -->
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between">
                <a href="{% url 'flight-list' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-times"></i> Cancel
                </a>
                <button type="submit" class="btn btn-primary">
                    {% if form.instance.pk %}Update Flight{% else %}Log Flight{% endif %}
                </button>
            </div>
        </div>
    </div>
</form>

<script>
// Update total time when departure/arrival times change
document.addEventListener('DOMContentLoaded', function() {
    const departureTime = document.getElementById('id_departure_time');
    const arrivalTime = document.getElementById('id_arrival_time');
    const dateField = document.getElementById('id_date');
    
    // Global variable to store total time in minutes for time input fields
    window.totalTimeMinutes = {{ total_time_minutes|default:0 }};
    
    function updateTotalTime() {
        if (departureTime.value && arrivalTime.value && dateField.value) {
            const departure = new Date(dateField.value + 'T' + departureTime.value);
            const arrival = new Date(dateField.value + 'T' + arrivalTime.value);
            
            if (arrival < departure) {
                arrival.setDate(arrival.getDate() + 1);
            }
            
            const diffMs = arrival - departure;
            const diffMins = Math.round(diffMs / 60000);
            
            // Update the global total time for fill buttons
            window.totalTimeMinutes = diffMins;
            
            // Update all fill buttons with new total time
            const fillButtons = document.querySelectorAll('[onclick*="fillFullTime"]');
            fillButtons.forEach(button => {
                const onclick = button.getAttribute('onclick');
                const newOnclick = onclick.replace(/fillFullTime\('([^']+)', \d+\)/, `fillFullTime('$1', ${diffMins})`);
                button.setAttribute('onclick', newOnclick);
            });
        }
    }
    
    departureTime.addEventListener('change', updateTotalTime);
    arrivalTime.addEventListener('change', updateTotalTime);
    dateField.addEventListener('change', updateTotalTime);
    
    // Initialize total time on page load
    updateTotalTime();
});
</script>
